<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocalización con UTM y Altitud</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f4f8; 
            margin: 0; 
            padding: 20px; 
        }
        h1 {
            text-align: center; 
            color: #2c3e50;
        }
        .container {
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        button {
            background-color: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            transition: background-color 0.3s;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background-color: #2980b9;
        }
        label {
            display: block; 
            margin: 5px 0; 
            color: #34495e;
        }
        input[type="text"], select {
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            margin-bottom: 10px;
            font-size: 16px; 
        }
        .row {
            display: flex; 
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .col-3 {
            width: 31%;
        }
        .col-2 {
            width: 48%;
        }
        #mensaje {
            color: red; 
            margin-top: 20px; 
            text-align: center;
        }
        @media (max-width: 600px) {
            .col-3, .col-2 {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
</head>
<body>
    <div class="container">
        <h1>Registro de Coordenadas con UTM y Altitud</h1>
        <div class="row">
            <div class="col-3">
                <label for="zonaUTM">Zona UTM:</label>
                <select id="zonaUTM">
                    <option value="17S">17S</option>
                    <option value="18S">18S</option>
                    <option value="19S">19S</option>
                </select>
            </div>
            <div class="col-3">
                <label for="latitud">Latitud:</label>
                <input type="text" id="latitud" readonly>
            </div>
            <div class="col-3">
                <label for="longitud">Longitud:</label>
                <input type="text" id="longitud" readonly>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <label for="utmX">Este (UTM X):</label>
                <input type="text" id="utmX" readonly>
            </div>
            <div class="col-2">
                <label for="utmY">Norte (UTM Y):</label>
                <input type="text" id="utmY" readonly>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <label for="altitud">Altitud (m):</label>
                <input type="text" id="altitud" readonly>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <button id="obtenerUbicacion">Obtener Coordenadas</button>
            </div>
            <div class="col-2">
                <button id="guardarKML">Guardar KML</button>
            </div>
        </div>
        <div id="mensaje"></div>
    </div>

    <script>
        document.getElementById('obtenerUbicacion').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    function(position) {
                        const latitud = position.coords.latitude;
                        const longitud = position.coords.longitude;
                        const altitud = position.coords.altitude;

                        document.getElementById('latitud').value = latitud.toFixed(6);
                        document.getElementById('longitud').value = longitud.toFixed(6);
                        document.getElementById('altitud').value = altitud ? altitud.toFixed(2) : 'No disponible';

                        const zonaUTM = document.getElementById('zonaUTM').value;
                        const utmCoords = latLonToUTM(latitud, longitud, zonaUTM);

                        document.getElementById('utmX').value = utmCoords[0].toFixed(2);
                        document.getElementById('utmY').value = utmCoords[1].toFixed(2);

                        document.getElementById('mensaje').textContent = '';
                    },
                    function(error) {
                        handleGeolocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Geolocalización no es soportada en este navegador.');
            }
        });

        function handleGeolocationError(error) {
            let mensaje;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    mensaje = "Permiso denegado. Por favor, permite el acceso a la ubicación en la configuración de tu navegador.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensaje = "La ubicación no está disponible. Asegúrate de que los servicios de ubicación estén habilitados.";
                    break;
                case error.TIMEOUT:
                    mensaje = "El tiempo de espera para obtener la ubicación ha expirado.";
                    break;
                default:
                    mensaje = "Ha ocurrido un error desconocido.";
            }
            document.getElementById('mensaje').textContent = mensaje;
        }

        function latLonToUTM(lat, lon, zonaUTM) {
            const wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
            let utm;

            switch (zonaUTM) {
                case '17S':
                    utm = "+proj=utm +zone=17 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
                    break;
                case '18S':
                    utm = "+proj=utm +zone=18 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
                    break;
                case '19S':
                    utm = "+proj=utm +zone=19 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
                    break;
            }

            return proj4(wgs84, utm, [lon, lat]);
        }

        document.getElementById('guardarKML').addEventListener('click', function() {
            const latitud = document.getElementById('latitud').value;
            const longitud = document.getElementById('longitud').value;
            const altitud = document.getElementById('altitud').value;
            const utmX = document.getElementById('utmX').value;
            const utmY = document.getElementById('utmY').value;

            if (!latitud || !longitud) {
                alert('Por favor, obtén las coordenadas antes de guardar el KML.');
                return;
            }

            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
            <kml xmlns="http://www.opengis.net/kml/2.2">
                <Placemark>
                    <name>Ubicación Actual</name>
                    <description>
                        <![CDATA[
                            <p>Coordenadas:</p>
                            <p>Latitud: ${latitud}</p>
                            <p>Longitud: ${longitud}</p>
                            <p>Altitud: ${altitud}</p>
                            <p>UTM X: ${utmX}</p>
                            <p>UTM Y: ${utmY}</p>
                        ]]>
                    </description>
                    <Point>
                        <coordinates>${longitud},${latitud},${altitud === 'No disponible' ? 0 : altitud}</coordinates>
                    </Point>
                </Placemark>
            </kml>`;

            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'coordenadas.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
